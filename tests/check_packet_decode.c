#include <packet_private.h>
#include <check.h>

#include "test.h"

/* eth:pppoe:ppp:ip4:tcp */
const uint8_t pkt10[] = {
    0x02, 0x09, 0x08, 0x07, 0x06, 0x05, 0x02, 0x01, 0x02, 0x03, 
    0x04, 0x05, 0x88, 0x64, 0x00, 0x00, 0x00, 0x02, 0x00, 0xC0, 
    0x00, 0x21, 0x45, 0x00, 0x00, 0xBE, 0x00, 0x06, 0x00, 0x00, 
    0x40, 0x06, 0x5C, 0x21, 0x0A, 0x01, 0x02, 0x03, 0x0A, 0x09, 
    0x08, 0x07, 0xBD, 0xEC, 0x00, 0x08, 0x00, 0x00, 0x01, 0xC4, 
    0x00, 0x00, 0x00, 0x02, 0x50, 0x18, 0x01, 0x00, 0xC8, 0xB2, 
    0x00, 0x00, 0x6C, 0x2C, 0x20, 0x77, 0x65, 0x20, 0x64, 0x69, 
    0x64, 0x20, 0x64, 0x6F, 0x20, 0x74, 0x68, 0x65, 0x20, 0x68, 
    0x65, 0x61, 0x64, 0x65, 0x72, 0x2E, 0x0A, 0x47, 0x4F, 0x52, 
    0x45, 0x3A, 0x20, 0x54, 0x68, 0x65, 0x20, 0x68, 0x65, 0x61, 
    0x64, 0x65, 0x72, 0x3F, 0x0A, 0x42, 0x49, 0x44, 0x45, 0x4E, 
    0x3A, 0x20, 0x41, 0x6E, 0x64, 0x20, 0x74, 0x68, 0x65, 0x20, 
    0x74, 0x72, 0x61, 0x69, 0x6C, 0x65, 0x72, 0x20, 0x2D, 0x2D, 
    0x20, 0x62, 0x75, 0x74, 0x20, 0x73, 0x68, 0x65, 0x20, 0x69, 
    0x73, 0x20, 0x61, 0x20, 0x70, 0x61, 0x63, 0x6B, 0x65, 0x74, 
    0x21, 0x0A, 0x43, 0x52, 0x4F, 0x57, 0x44, 0x3A, 0x20, 0x52, 
    0x6F, 0x75, 0x74, 0x65, 0x20, 0x68, 0x65, 0x72, 0x21, 0x20, 
    0x20, 0x50, 0x61, 0x63, 0x6B, 0x65, 0x74, 0x21, 0x20, 0x20, 
    0x50, 0x61, 0x63, 0x6B, 0x65, 0x74, 0x21, 0x20, 0x20, 0x52, 
    0x6F, 0x75, 0x74, 0x65, 0x20, 0x68, 0x65, 0x72, 0x21, 0x0A, 
    0x47, 0x4F, 0x52, 0x45, 0x3A, 0x20, 0x44, 0x69, 0x64, 0x20, 
    0x79, 0x6F
};

START_TEST(test_packet_decode_with_null_packet)
{
    Packet *packet = packet_create( );

    int err = packet_decode(NULL, pkt10, sizeof pkt10);

    fail_unless((packet != NULL), "packet_decode with NULL Packet");
    fail_unless((err != 0), "packet_decode returned OK expected ERROR");

    packet_destroy(packet);
}
END_TEST

START_TEST(test_packet_decode_with_null_data_pointer)
{
    Packet *packet = packet_create( );

    int err = packet_decode(packet, NULL, sizeof pkt10);

    fail_unless((err != 0), "packet_decode returned OK expected ERROR");

    packet_destroy(packet);
}
END_TEST

START_TEST(test_packet_decode_with_zero_size)
{
    Packet *packet = packet_create( );

    int err = packet_decode(packet, pkt10, 0);

    fail_unless((err != 0), "packet_decode returned OK expected ERROR");

    packet_destroy(packet);
}
END_TEST

/* XXX
 * This test isn't really supposed to be here but its the best way to
 * validate that the decode went through the entire packet */
START_TEST(test_packet_proto_count)
{
    Packet *packet = packet_create( );

    int err = packet_decode(packet, pkt10, sizeof pkt10);

    fail_unless((err == 0), "packet_decode returned ERROR");

    err = packet_proto_count(packet);
    fail_unless((err == 5), 
        "packet_proto_count(packet) returned %d, expected 5", err);

    unsigned i;
    Protocol *proto = packet_proto_first(packet, &i);
    fail_unless((packet_proto_proto(proto) == PROTO_ETH), 
        "layer %d not ETH");

    proto = packet_proto_next(packet, &i);
    fail_unless((packet_proto_proto(proto) == PROTO_PPPOE), 
        "layer %d not PPPOE");

    proto = packet_proto_next(packet, &i);
    fail_unless((packet_proto_proto(proto) == PROTO_PPP), 
        "layer %d not PPP");

    proto = packet_proto_next(packet, &i);
    fail_unless((packet_proto_proto(proto) == PROTO_IP4), 
        "layer %d not IP4");

    proto = packet_proto_next(packet, &i);
    fail_unless((packet_proto_proto(proto) == PROTO_TCP), 
        "layer %d not TCP");

    packet_destroy(packet);
}
END_TEST

Suite * packet_decode_suite(void)
{
    Suite *s = suite_create("Check Packet Decode");
    TCase *tc = tcase_create("Positive");

    suite_add_tcase(s, tc);
    tcase_add_test(tc, test_packet_decode_with_null_packet);
    tcase_add_test(tc, test_packet_decode_with_null_data_pointer);
    tcase_add_test(tc, test_packet_decode_with_zero_size);
    tcase_add_test(tc, test_packet_proto_count);

    return s;
}

MAIN(packet_decode_suite);
